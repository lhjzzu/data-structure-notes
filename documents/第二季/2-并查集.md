## å¹¶æŸ¥é›† (Union Find)

### éœ€æ±‚åˆ†æ

+ å‡è®¾æœ‰nä¸ªæ‘åº„ï¼Œæœ‰äº›æ‘åº„ä¹‹é—´æœ‰è¿æ¥çš„è·¯ï¼Œæœ‰äº›æ‘åº„ä¹‹é—´å¹¶æ²¡æœ‰è¿æ¥çš„è·¯

  ![](./images/å¹¶æŸ¥é›†0.png)

+ è®¾è®¡ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œèƒ½å¤Ÿå¿«é€Ÿæ‰§è¡Œ2ä¸ªæ“ä½œ

  - æŸ¥è¯¢2ä¸ªæ‘åº„ä¹‹é—´æ˜¯å¦æœ‰è¿æ¥çš„è·¯
  - è¿æ¥2ä¸ªæ‘åº„

+ æ•°ç»„ã€é“¾è¡¨ã€å¹³è¡¡äºŒå‰æ ‘ã€é›†åˆï¼ˆSetï¼‰ï¼Ÿ

  - æŸ¥è¯¢ã€è¿æ¥çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ï¼šO(n)

+ å¹¶æŸ¥é›†èƒ½å¤ŸåŠåˆ°æŸ¥è¯¢ã€è¿æ¥çš„å‡æ‘Šæ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(Î±(n)) ï¼ŒÎ±(n) < 5

+ å¹¶æŸ¥é›†éå¸¸é€‚åˆè§£å†³è¿™ç±»â€œè¿æ¥â€ç›¸å…³çš„é—®é¢˜

### åŸºæœ¬æ¦‚å¿µ

+ å¹¶æŸ¥é›†ä¹Ÿå«ä½œä¸ç›¸äº¤é›†åˆï¼ˆ**Disjoint Set**ï¼‰
+ å¹¶æŸ¥é›†æœ‰2ä¸ªæ ¸å¿ƒæ“ä½œ
  - æŸ¥æ‰¾ï¼ˆFindï¼‰ï¼šæŸ¥æ‰¾å…ƒç´ æ‰€åœ¨çš„é›†åˆï¼ˆè¿™é‡Œçš„é›†åˆå¹¶ä¸æ˜¯ç‰¹æŒ‡Setè¿™ç§æ•°æ®ç»“æ„ï¼Œæ˜¯æŒ‡å¹¿ä¹‰çš„æ•°æ®é›†åˆï¼‰
  - åˆå¹¶ï¼ˆUnionï¼‰ï¼šå°†ä¸¤ä¸ªå…ƒç´ æ‰€åœ¨çš„é›†åˆåˆå¹¶ä¸ºä¸€ä¸ªé›†åˆ
+ æœ‰2ç§å¸¸è§çš„å®ç°æ€è·¯
  - Quick Find
    - æŸ¥æ‰¾ï¼ˆFindï¼‰çš„æ—¶é—´å¤æ‚åº¦ï¼šO(1)
    - åˆå¹¶ï¼ˆUnionï¼‰çš„æ—¶é—´å¤æ‚åº¦ï¼šO(n)
  - <font color=red>Quick Union</font>
    - æŸ¥æ‰¾ï¼ˆFindï¼‰çš„æ—¶é—´å¤æ‚åº¦ï¼šO(logn)ï¼Œå¯ä»¥ä¼˜åŒ–è‡³ O(Î±(ğ‘›)) ï¼ŒÎ±(ğ‘›) < 5
    - åˆå¹¶ï¼ˆUnionï¼‰çš„æ—¶é—´å¤æ‚åº¦ï¼šO(logn)ï¼Œå¯ä»¥ä¼˜åŒ–è‡³ O(Î±(ğ‘›)) ï¼ŒÎ±(ğ‘›) < 5

### å¦‚ä½•å­˜å‚¨æ•°æ®?

+ å‡è®¾å¹¶æŸ¥é›†å¤„ç†çš„æ•°æ®éƒ½æ˜¯æ•´å‹ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨æ•´å‹æ•°ç»„æ¥å­˜å‚¨æ•°æ®

  ![](./images/å¹¶æŸ¥é›†1.png)

+ ä¸éš¾çœ‹å‡º
  - 0ã€1ã€3 å±äºåŒä¸€é›†åˆ
  - 2 å•ç‹¬å±äºä¸€ä¸ªé›†åˆ
  - 4ã€5ã€6ã€7 å±äºåŒä¸€é›†åˆ
  - å…¶å¯¹åº”ä½ç½®å­˜å‚¨çš„å€¼ï¼Œå³ä¸ºå®ƒä»¬çš„çˆ¶èŠ‚ç‚¹
+ å› æ­¤ï¼Œå¹¶æŸ¥é›†æ˜¯å¯ä»¥ç”¨æ•°ç»„å®ç°çš„æ ‘å½¢ç»“æ„ï¼ˆäºŒå‰å †ã€ä¼˜å…ˆçº§é˜Ÿåˆ—ä¹Ÿæ˜¯å¯ä»¥ç”¨æ•°ç»„å®ç°çš„æ ‘å½¢ç»“æ„ï¼‰

### æ¥å£å®šä¹‰

![](./images/å¹¶æŸ¥é›†2.png)

### åˆå§‹åŒ–

+ åˆå§‹åŒ–æ—¶ï¼Œæ¯ä¸ªå…ƒç´ å„è‡ªå±äºä¸€ä¸ªå•å…ƒç´ é›†åˆ

  ![](./images/å¹¶æŸ¥é›†3.png)

### Quick Find

#### Unionæ“ä½œ

+ Quick Find çš„ union(v1, v2)ï¼šè®© v1 æ‰€åœ¨é›†åˆçš„æ‰€æœ‰å…ƒç´ éƒ½æŒ‡å‘ v2 çš„æ ¹èŠ‚ç‚¹

  ![](./images/å¹¶æŸ¥é›†4.png)

  ![](./images/å¹¶æŸ¥é›†5.png)

  + union(1,0)ï¼Œå°†å·¦è¾¹å…ƒç´ 1æ‰€åœ¨çš„é›†åˆçš„æ‰€æœ‰å…ƒç´ çš„çˆ¶èŠ‚ç‚¹ï¼Œæ”¹ä¸ºå³è¾¹å…ƒç´ 0çš„çˆ¶èŠ‚ç‚¹ï¼Œè¿™æ ·ä¸¤ä¸ªé›†åˆå°±è¿èµ·æ¥äº†ã€‚å› æ­¤1çš„çˆ¶èŠ‚ç‚¹å˜ä¸º0
  + union(1,2)ï¼Œ å°†å·¦è¾¹å…ƒç´ 1æ‰€åœ¨çš„é›†åˆçš„æ‰€æœ‰å…ƒç´ çš„çˆ¶èŠ‚ç‚¹ï¼Œæ”¹ä¸ºå³è¾¹å…ƒç´ 2çš„çˆ¶èŠ‚ç‚¹.å› æ­¤0ï¼Œ 1çš„çˆ¶èŠ‚ç‚¹å˜ä¸º2
  + æœ€ç»ˆå°†æ‰€æœ‰çš„å…ƒç´ éƒ½è¿æ¥åœ¨ä¸€èµ·æ—¶ï¼Œæ‰€æœ‰çš„å…ƒç´ æ‹¥æœ‰ä¸€ä¸ªå…±åŒçš„æ ¹èŠ‚ç‚¹

#### Findæ“ä½œ

![](./images/å¹¶æŸ¥é›†7.png)

+ å¯¹åº”å­˜å‚¨çš„å…ƒç´ å°±æ˜¯å¯¹åº”çš„çˆ¶èŠ‚ç‚¹
+ æ—¶é—´å¤æ‚åº¦ä¸ºO(1)

#### ä»£ç å®ç°

```java
package com.mj.union;

/**
 * Quick Find
 * @author MJ Lee
 *
 */
public class UnionFind_QF extends UnionFind {
	public UnionFind_QF(int capacity) {
		super(capacity);
	}

	/*
	 * çˆ¶èŠ‚ç‚¹å°±æ˜¯æ ¹èŠ‚ç‚¹
	 */
	public int find(int v) {
		rangeCheck(v);
		return parents[v];
	}

	/**
	 * å°†v1æ‰€åœ¨é›†åˆçš„æ‰€æœ‰å…ƒç´ ï¼Œéƒ½å«æ¥åˆ°v2çš„çˆ¶èŠ‚ç‚¹ä¸Š
	 */
	public void union(int v1, int v2) {
    //p1å³ä¸ºv1çš„æ ¹èŠ‚ç‚¹
    //p2å³ä¸ºv2çš„æ ¹èŠ‚ç‚¹
		int p1 = find(v1);
		int p2 = find(v2);
		if (p1 == p2) return;
		for (int i = 0; i < parents.length; i++) {
			if (parents[i] == p1) {
				parents[i] = p2;
			}
		}
	}
}
```

### Quick Union 

#### Unionæ“ä½œ

+ Quick Union çš„ union(v1, v2)ï¼šè®© v1 çš„æ ¹èŠ‚ç‚¹æŒ‡å‘ v2 çš„æ ¹èŠ‚ç‚¹

  ![](./images/å¹¶æŸ¥é›†8.png)

  ![](./images/å¹¶æŸ¥é›†9.png)

  + union(1,2) ï¼Œ è®©1æ‰€åœ¨é›†åˆçš„**æ ¹èŠ‚ç‚¹0**çš„çˆ¶èŠ‚ç‚¹ï¼Œå˜ä¸º2æ‰€åœ¨é›†åˆçš„**æ ¹èŠ‚ç‚¹2**ã€‚å› æ­¤å°†0ä½ç½®å¯¹åº”çš„å…ƒç´ å˜ä¸º2

#### findæ“ä½œ

![](./images/å¹¶æŸ¥é›†10.png)

+ find(0) == 2
+ find(1) == 2
+ find(3) == 2
+ find(2) == 2
+ æ—¶é—´å¤æ‚åº¦ï¼šO(logn)

#### ä»£ç å®ç°

```java
/**
 * Quick Union
 * @author MJ Lee
 *
 */
public class UnionFind_QU extends UnionFind {

	public UnionFind_QU(int capacity) {
		super(capacity);
	}
	/**
	 * é€šè¿‡parenté“¾æ¡ä¸æ–­åœ°å‘ä¸Šæ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æ ¹èŠ‚ç‚¹
	 */
	public int find(int v) {
		rangeCheck(v);
		while (v != parents[v]) {
			v = parents[v];
		}
		return v;
	}

	/**
	 * å°†v1çš„æ ¹èŠ‚ç‚¹å«æ¥åˆ°v2çš„æ ¹èŠ‚ç‚¹ä¸Š
	 */
	public void union(int v1, int v2) {
		int p1 = find(v1);
		int p2 = find(v2);
		if (p1 == p2) return;
		parents[p1] = p2;
	}

}
```



####  ä¼˜åŒ–

+ åœ¨Unionçš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°æ ‘ä¸å¹³è¡¡çš„æƒ…å†µï¼Œç”šè‡³é€€åŒ–æˆé“¾è¡¨

  ![](./images/å¹¶æŸ¥é›†11.png)

+ æœ‰2ç§å¸¸è§çš„ä¼˜åŒ–æ–¹æ¡ˆ
  - åŸºäºsizeçš„ä¼˜åŒ–ï¼šå…ƒç´ å°‘çš„æ ‘ å«æ¥åˆ° å…ƒç´ å¤šçš„æ ‘
  - <font color=red>åŸºäºrankçš„ä¼˜åŒ–</font>ï¼šçŸ®çš„æ ‘ å«æ¥åˆ° é«˜çš„æ ‘

##### åŸºäºsizeçš„ä¼˜åŒ–

![](./images/å¹¶æŸ¥é›†12.png)

+ åŸºäºsizeçš„ä¼˜åŒ–ï¼Œä¹Ÿå¯èƒ½ä¼šå­˜åœ¨æ ‘ä¸å¹³è¡¡çš„é—®é¢˜

  ![](./images/å¹¶æŸ¥é›†13.png)

+ ä»£ç å®ç°

  ```java
  /**
   * Quick Union - åŸºäºsizeçš„ä¼˜åŒ–
   * @author MJ Lee
   *
   */
  public class UnionFind_QU_S extends UnionFind_QU {
  	private int[] sizes;
  
  	public UnionFind_QU_S(int capacity) {
  		super(capacity);
  		
  		sizes = new int[capacity];
  		for (int i = 0; i < sizes.length; i++) {
  			sizes[i] = 1;
  		}
  	}
  
  	/**
  	 * å°†v1çš„æ ¹èŠ‚ç‚¹å«æ¥åˆ°v2çš„æ ¹èŠ‚ç‚¹ä¸Š
  	 */
  	public void union(int v1, int v2) {
  		int p1 = find(v1);
  		int p2 = find(v2);
  		if (p1 == p2) return;
  		//å°†èŠ‚ç‚¹æ•°é‡å°‘çš„ï¼Œæ”¾åˆ°èŠ‚ç‚¹æ•°é‡å¤šçš„ä¸‹é¢
  		if (sizes[p1] < sizes[p2]) {
  			parents[p1] = p2;
  			sizes[p2] += sizes[p1];
  		} else {
  			parents[p2] = p1;
  			sizes[p1] += sizes[p2];
  		}
  	}
  
  }
  ```

##### åŸºäºrankçš„ä¼˜åŒ–

![](./images/å¹¶æŸ¥é›†14.png)

+ ä»£ç å®ç°

  ```java
  package com.mj.union;
  
  /**
   * Quick Union - åŸºäºrankçš„ä¼˜åŒ–
   * @author MJ Lee
   *
   */
  public class UnionFind_QU_R extends UnionFind_QU {
  	private int[] ranks;
  
  	public UnionFind_QU_R(int capacity) {
  		super(capacity);
  
  		ranks = new int[capacity];
  		for (int i = 0; i < ranks.length; i++) {
  			ranks[i] = 1;
  		}
  	}
  	
  	public void union(int v1, int v2) {
  		int p1 = find(v1);
  		int p2 = find(v2);
  		if (p1 == p2) return;
  		
  		if (ranks[p1] < ranks[p2]) {
  			parents[p1] = p2;
  		} else if (ranks[p1] > ranks[p2]) {
  			parents[p2] = p1;
  		} else {
  			parents[p1] = p2;
  			ranks[p2] += 1;
  		}
  	}
  }
  
  ```

###### è·¯å¾„å‹ç¼© ï¼ˆPath Compressionï¼‰

![](./images/å¹¶æŸ¥é›†15.png)

+ è·¯å¾„å‹ç¼©ä½¿è·¯å¾„ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æŒ‡å‘æ ¹èŠ‚ç‚¹ï¼Œæ‰€ä»¥å®ç°æˆæœ¬ç¨é«˜

+ è¿˜æœ‰2ç§æ›´ä¼˜çš„åšæ³•ï¼Œä¸ä½†èƒ½é™ä½æ ‘é«˜ï¼Œå®ç°æˆæœ¬ä¹Ÿæ¯”è·¯å¾„å‹ç¼©ä½

  - è·¯å¾„åˆ†è£‚ï¼ˆPath Splitingï¼‰
  - è·¯å¾„å‡åŠï¼ˆPath Halvingï¼‰

+ è·¯å¾„åˆ†è£‚ã€è·¯å¾„å‡åŠçš„æ•ˆç‡å·®ä¸å¤šï¼Œä½†éƒ½æ¯”è·¯å¾„å‹ç¼©è¦å¥½

+ ä»£ç å®ç°

  ```java
  /**
   * Quick Union - åŸºäºrankçš„ä¼˜åŒ– - è·¯å¾„å‹ç¼©(Path Compression)
   * @author MJ Lee
   *
   */
  public class UnionFind_QU_R_PC extends UnionFind_QU_R {
  
  	public UnionFind_QU_R_PC(int capacity) {
  		super(capacity);
  	}
  	
  	@Override
  	public int find(int v) { // v == 1, parents[v] == 2
  		rangeCheck(v);
  		if (parents[v] != v) {
  			parents[v] = find(parents[v]);
  		}
  		return parents[v];
  	}
  }
  
  ```

  

###### è·¯å¾„åˆ†è£‚ï¼ˆPath Splitingï¼‰

![](./images/å¹¶æŸ¥é›†16.png)

+ ä»£ç å®ç°

  ```java
  
  /**
   * Quick Union - åŸºäºrankçš„ä¼˜åŒ– - è·¯å¾„åˆ†è£‚(Path Spliting)
   * @author MJ Lee
   *
   */
  public class UnionFind_QU_R_PS extends UnionFind_QU_R {
  
  	public UnionFind_QU_R_PS(int capacity) {
  		super(capacity);
  	}
  	
  	@Override
  	public int find(int v) { 
  		rangeCheck(v);
  		while (v != parents[v]) {
  			int p = parents[v];
  			parents[v] = parents[parents[v]];
  			v = p;
  		}
  		return v;
  	}
  }
  ```

  

###### è·¯å¾„å‡åŠï¼ˆPath Halvingï¼‰

![](./images/å¹¶æŸ¥é›†17.png)

```java
/**
 * Quick Union - åŸºäºrankçš„ä¼˜åŒ– - è·¯å¾„å‡åŠ(Path Halving)
 * @author MJ Lee
 *
 */
public class UnionFind_QU_R_PH extends UnionFind_QU_R {

	public UnionFind_QU_R_PH(int capacity) {
		super(capacity);
	}
	
	@Override
	public int find(int v) { 
		rangeCheck(v);
		while (v != parents[v]) {
			parents[v] = parents[parents[v]];
			v = parents[v];
		}
		return v;
	}
}
```



### æ€»ç»“

+ æ‘˜è‡ªã€Šç»´åŸºç™¾ç§‘ã€‹ï¼š https://en.wikipedia.org/wiki/Disjoint-set_data_structure#Time_complexity

  ![](./images/å¹¶æŸ¥é›†18.png)

+ å¤§æ¦‚æ„æ€æ˜¯
  - ä½¿ç”¨è·¯å¾„å‹ç¼©ã€åˆ†è£‚æˆ–å‡åŠ + åŸºäºrankæˆ–è€…sizeçš„ä¼˜åŒ–
    - å¯ä»¥ç¡®ä¿æ¯ä¸ªæ“ä½œçš„å‡æ‘Šæ—¶é—´å¤æ‚åº¦ä¸º O(Î±(ğ‘›)) ï¼ŒÎ±(ğ‘›) < 5
+ ä¸ªäººå»ºè®®çš„æ­é…
  - Quick Union
  - åŸºäº rank çš„ä¼˜åŒ–
  -  Path Halving æˆ– Path Spliting

### è‡ªå®šä¹‰ç±»å‹

+ ä¹‹å‰çš„ä½¿ç”¨éƒ½æ˜¯åŸºäºæ•´å‹æ•°æ®ï¼Œå¦‚æœå…¶ä»–è‡ªå®šä¹‰ç±»å‹ä¹Ÿæƒ³ä½¿ç”¨å¹¶æŸ¥é›†å‘¢ï¼Ÿ
  - æ–¹æ¡ˆä¸€ï¼šé€šè¿‡ä¸€äº›æ–¹æ³•å°†è‡ªå®šä¹‰ç±»å‹è½¬ä¸ºæ•´å‹åä½¿ç”¨å¹¶æŸ¥é›†ï¼ˆæ¯”å¦‚ç”Ÿæˆå“ˆå¸Œå€¼ï¼‰
  - æ–¹æ¡ˆäºŒï¼šä½¿ç”¨é“¾è¡¨+æ˜ å°„ï¼ˆMapï¼‰

```java
public class GenericUnionFind<V> {
	private Map<V, Node<V>> nodes = new HashMap<>();

	public void makeSet(V v) {
		if (nodes.containsKey(v)) return;
		nodes.put(v, new Node<>(v));
	}
	
	/**
	 * æ‰¾å‡ºvçš„æ ¹èŠ‚ç‚¹
	 */
	private Node<V> findNode(V v) {
		Node<V> node = nodes.get(v);
		if (node == null) return null;
		while (!Objects.equals(node.value, node.parent.value)) {
			node.parent = node.parent.parent;
			node = node.parent;
		}
		return node;
	}
	
	public V find(V v) {
		Node<V> node = findNode(v);
		return node == null ? null : node.value;
	}
	
	public void union(V v1, V v2) {
		Node<V> p1 = findNode(v1);
		Node<V> p2 = findNode(v2);
		if (p1 == null || p2 == null) return;
		if (Objects.equals(p1.value, p2.value)) return;
		
		if (p1.rank < p2.rank) {
			p1.parent = p2;
		} else if (p1.rank > p2.rank) {
			p2.parent = p1;
		} else {
			p1.parent = p2;
			p2.rank += 1;
		}
	}
	
	public boolean isSame(V v1, V v2) {
		return Objects.equals(find(v1), find(v2));
	}
	
	private static class Node<V> {
		V value;
		Node<V> parent = this;
		int rank = 1;
		Node(V value) {
			this.value = value;
		}
	}
}

```

